<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Scanner Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- pdf-lib: A powerful library for creating and modifying PDFs -->
    <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
    <!-- SortableJS: For drag-and-drop functionality -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior: none; /* Prevents pull-to-refresh on mobile */
        }
        #loader {
            border-top-color: #3498db;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* Style for the dragged item */
        .sortable-ghost {
            opacity: 0.4;
            background-color: #c0d9ff;
        }
        /* Style for the item being dragged */
        .sortable-chosen {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        #camera-stream {
            transform: scaleX(-1); /* Mirror view for webcams */
        }
        .captured-thumbnail img {
            transform: scaleX(-1); /* Un-mirror the final capture */
        }
    </style>
</head>
<body class="bg-gray-200 text-gray-800">

    <div class="w-full max-w-7xl mx-auto p-4 md:p-6">
        <header class="text-center mb-6 bg-white p-6 rounded-xl shadow-md">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Web PDF Scanner</h1>
            <p class="text-gray-500 mt-2">Use your device's camera to scan documents into a PDF.</p>
        </header>

        <!-- Start Screen -->
        <div id="start-container" class="w-full bg-white rounded-xl shadow-lg p-8 text-center">
            <h2 class="text-2xl font-semibold mb-4">Ready to Scan?</h2>
            <p class="text-gray-600 mb-6">This tool needs access to your camera. Please grant permission when prompted.</p>
            <button id="start-camera-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-8 rounded-lg transition duration-300 shadow-lg text-lg flex items-center justify-center mx-auto">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                  <path stroke-linecap="round" stroke-linejoin="round" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
                Start Camera
            </button>
        </div>

        <!-- Main Scanner UI -->
        <div id="scanner-app" class="hidden grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Camera View -->
            <div class="bg-black rounded-xl shadow-lg p-4 flex flex-col items-center justify-center min-h-[400px]">
                <video id="camera-stream" class="w-full h-auto rounded-lg" autoplay playsinline></video>
                <button id="capture-btn" class="mt-4 bg-white hover:bg-gray-200 text-gray-800 font-bold w-20 h-20 rounded-full transition duration-300 shadow-xl border-4 border-gray-300 flex items-center justify-center">
                    <div class="w-16 h-16 bg-red-500 rounded-full"></div>
                </button>
            </div>
            
            <!-- Captured Pages -->
            <div class="bg-white rounded-xl shadow-lg p-4 flex flex-col">
                <h2 class="text-xl font-bold mb-4 text-center border-b pb-2">Captured Pages</h2>
                <div id="thumbnail-container" class="flex-grow space-y-3 overflow-y-auto min-h-[300px] p-2 bg-gray-50 rounded-lg">
                    <!-- Thumbnails will be added here -->
                    <p id="placeholder-text" class="text-gray-500 text-center mt-8">Your captured pages will appear here. Drag to reorder.</p>
                </div>
                <div class="mt-4 flex flex-col sm:flex-row gap-3">
                    <button id="create-pdf-btn" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 shadow-md flex items-center justify-center">
                        Create & Download PDF
                    </button>
                    <button id="reset-btn" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300">
                        Start Over
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Hidden canvas for capturing frames -->
    <canvas id="capture-canvas" class="hidden"></canvas>
    
    <!-- Loading Indicator -->
    <div id="loading-overlay" class="hidden fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center">
        <div class="flex flex-col items-center">
            <div id="loader" class="w-16 h-16 border-4 border-gray-200 rounded-full"></div>
            <p id="loader-text" class="text-white text-xl mt-4">Processing...</p>
        </div>
    </div>

    <script>
        // DOM Elements
        const startContainer = document.getElementById('start-container');
        const startCameraBtn = document.getElementById('start-camera-btn');
        const scannerApp = document.getElementById('scanner-app');
        const video = document.getElementById('camera-stream');
        const captureBtn = document.getElementById('capture-btn');
        const thumbnailContainer = document.getElementById('thumbnail-container');
        const placeholderText = document.getElementById('placeholder-text');
        const createPdfBtn = document.getElementById('create-pdf-btn');
        const resetBtn = document.getElementById('reset-btn');
        const canvas = document.getElementById('capture-canvas');
        const context = canvas.getContext('2d');
        const loadingOverlay = document.getElementById('loading-overlay');
        const loaderText = document.getElementById('loader-text');

        let cameraStream = null;
        let capturedImages = [];
        let sortable = null;

        // --- Event Listeners ---
        startCameraBtn.addEventListener('click', startCamera);
        captureBtn.addEventListener('click', captureImage);
        createPdfBtn.addEventListener('click', createPdf);
        resetBtn.addEventListener('click', resetApp);
        
        // --- Functions ---
        
        function showModalAlert(title, message) {
            let existingModal = document.getElementById('custom-alert-modal');
            if (existingModal) existingModal.remove();

            const modalOverlay = document.createElement('div');
            modalOverlay.id = 'custom-alert-modal';
            modalOverlay.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
            
            const modalContent = document.createElement('div');
            modalContent.className = 'bg-white rounded-lg shadow-xl p-6 w-full max-w-md text-center';
            
            const modalTitle = document.createElement('h2');
            modalTitle.className = 'text-xl font-bold text-gray-800 mb-2';
            modalTitle.textContent = title;

            const modalMessage = document.createElement('p');
            modalMessage.className = 'text-gray-600 mb-4';
            modalMessage.textContent = message;
            
            const closeButton = document.createElement('button');
            closeButton.className = 'bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition duration-300';
            closeButton.textContent = 'OK';
            closeButton.onclick = () => modalOverlay.remove();
            
            modalContent.appendChild(modalTitle);
            modalContent.appendChild(modalMessage);
            modalContent.appendChild(closeButton);
            modalOverlay.appendChild(modalContent);
            document.body.appendChild(modalOverlay);
            closeButton.focus();
        }

        async function startCamera() {
            startContainer.classList.add('hidden');
            scannerApp.classList.remove('hidden');
            scannerApp.classList.add('grid');
            
            try {
                // Prefer the rear camera on mobile devices
                const constraints = { video: { facingMode: 'environment' } };
                cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = cameraStream;
                initializeSortable();
            } catch (err) {
                console.error("Error accessing camera:", err);
                showModalAlert(
                    'Camera Error', 
                    'Could not access the camera. Please ensure you have a camera connected and have granted permission. You might need to refresh the page and try again.'
                );
                resetApp();
            }
        }
        
        function initializeSortable() {
            if (sortable) sortable.destroy();
            sortable = new Sortable(thumbnailContainer, {
                animation: 150,
                ghostClass: 'sortable-ghost',
                chosenClass: 'sortable-chosen',
                onEnd: updatePageNumbers,
            });
        }
        
        function captureImage() {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            // Draw the video frame onto the canvas (mirrored)
            context.save();
            context.scale(-1, 1);
            context.drawImage(video, -canvas.width, 0, canvas.width, canvas.height);
            context.restore();
            
            const imageDataUrl = canvas.toDataURL('image/jpeg', 0.9); // 90% quality
            addThumbnail(imageDataUrl);
        }

        function addThumbnail(imageDataUrl) {
            placeholderText.classList.add('hidden');
            const pageIndex = capturedImages.length;
            capturedImages.push(imageDataUrl);

            const div = document.createElement('div');
            div.className = 'captured-thumbnail bg-white p-2 rounded-lg shadow-sm border flex items-center justify-between cursor-grab';
            div.dataset.index = pageIndex;

            div.innerHTML = `
                <div class="flex items-center">
                    <img src="${imageDataUrl}" class="w-16 h-20 object-cover rounded-md mr-4 border" alt="Captured Page">
                    <span class="page-number font-bold text-gray-700">Page ${pageIndex + 1}</span>
                </div>
                <button class="delete-btn text-red-500 hover:text-red-700 p-2 rounded-full">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                </button>
            `;
            
            thumbnailContainer.appendChild(div);
            
            div.querySelector('.delete-btn').addEventListener('click', () => {
                const indexToRemove = parseInt(div.dataset.index);
                // Remove from array based on original index, not its current position
                capturedImages[indexToRemove] = null; // Mark as null instead of splicing to preserve indices
                div.remove();
                updatePageNumbers();
                 if (thumbnailContainer.children.length <= 1) { // 1 because placeholder is a child
                    placeholderText.classList.remove('hidden');
                }
            });
        }
        
        function updatePageNumbers() {
            const thumbnails = thumbnailContainer.querySelectorAll('.captured-thumbnail');
            thumbnails.forEach((thumb, index) => {
                thumb.querySelector('.page-number').textContent = `Page ${index + 1}`;
            });
        }

        async function createPdf() {
            const finalImageOrder = Array.from(thumbnailContainer.querySelectorAll('.captured-thumbnail'))
                .map(thumb => {
                    const originalIndex = parseInt(thumb.dataset.index);
                    return capturedImages[originalIndex];
                })
                .filter(img => img !== null); // Filter out deleted images

            if (finalImageOrder.length === 0) {
                showModalAlert('No Pages', 'Please capture at least one page before creating a PDF.');
                return;
            }
            
            showLoader(true, 'Creating your PDF...');
            
            try {
                const { PDFDocument } = PDFLib;
                const pdfDoc = await PDFDocument.create();

                for (const imageDataUrl of finalImageOrder) {
                    const jpgImageBytes = await fetch(imageDataUrl).then(res => res.arrayBuffer());
                    const jpgImage = await pdfDoc.embedJpg(jpgImageBytes);
                    
                    const page = pdfDoc.addPage([jpgImage.width, jpgImage.height]);
                    page.drawImage(jpgImage, {
                        x: 0,
                        y: 0,
                        width: jpgImage.width,
                        height: jpgImage.height,
                    });
                }

                const pdfBytes = await pdfDoc.save();

                const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `scan-${new Date().toISOString().slice(0,10)}.pdf`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

            } catch (err) {
                console.error("Failed to create PDF:", err);
                showModalAlert('PDF Creation Failed', 'An error occurred while building the PDF. Please try again.');
            } finally {
                showLoader(false);
            }
        }
        
        function stopCamera() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
        }
        
        function resetApp() {
            stopCamera();
            capturedImages = [];
            thumbnailContainer.innerHTML = ''; // Clear thumbnails
            thumbnailContainer.appendChild(placeholderText);
            placeholderText.classList.remove('hidden');
            scannerApp.classList.add('hidden');
            scannerApp.classList.remove('grid');
            startContainer.classList.remove('hidden');
        }
        
        function showLoader(show, message = 'Processing...') {
            loaderText.textContent = message;
            loadingOverlay.classList.toggle('hidden', !show);
        }
    </script>
</body>
</html>

